<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PKB - Personal Knowledge Base</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
      background: #fafafa;
      color: #333;
    }
    h1 { margin-bottom: 1.5rem; font-size: 1.5rem; }
    .search-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .search-form input[type="text"] {
      flex: 1;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-form button {
      padding: 0.6rem 1.5rem;
      font-size: 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .search-form button:hover { background: #1d4ed8; }
    .sources {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .sources label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.9rem;
      color: #555;
    }
    #results { list-style: none; }
    #results li {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    #results li .title {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 0.25rem;
    }
    #results li .snippet {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.25rem;
    }
    #results li .url a {
      font-size: 0.85rem;
      color: #2563eb;
      text-decoration: none;
    }
    #results li .url a:hover { text-decoration: underline; }
    #results li .source {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.25rem;
    }
    #status {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    #error {
      color: #dc2626;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1>Search Your Knowledge Base</h1>

  <form class="search-form" id="searchForm">
    <input type="text" id="query" placeholder="Search..." autofocus>
    <button type="submit">Search</button>
  </form>

  <div class="sources">
    <label><input type="checkbox" name="source" value="gdrive" checked> Google Drive</label>
    <label><input type="checkbox" name="source" value="gmail"> Gmail</label>
  </div>

  <div id="status"></div>
  <div id="error"></div>
  <ul id="results"></ul>

  <script>
    const form = document.getElementById('searchForm');
    const queryInput = document.getElementById('query');
    const resultsList = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = queryInput.value.trim();
      if (!q) return;

      const checked = document.querySelectorAll('input[name="source"]:checked');
      const sources = Array.from(checked).map(cb => cb.value).join(',');

      statusEl.textContent = 'Searching...';
      errorEl.textContent = '';
      resultsList.innerHTML = '';

      try {
        let url = '/search?q=' + encodeURIComponent(q);
        if (sources) url += '&sources=' + encodeURIComponent(sources);

        const resp = await fetch(url);
        const data = await resp.json();

        if (!resp.ok) {
          errorEl.textContent = data.error || 'Search failed';
          statusEl.textContent = '';
          return;
        }

        statusEl.textContent = data.length === 0
          ? 'No results found.'
          : data.length + ' result' + (data.length === 1 ? '' : 's');

        data.forEach(r => {
          const li = document.createElement('li');
          li.innerHTML =
            '<div class="title">' + escapeHtml(r.Title) + '</div>' +
            (r.Snippet ? '<div class="snippet">' + escapeHtml(r.Snippet) + '</div>' : '') +
            (r.URL ? '<div class="url"><a href="' + escapeHtml(r.URL) + '" target="_blank">' + escapeHtml(r.URL) + '</a></div>' : '') +
            '<div class="source">' + escapeHtml(r.Source) + '</div>';
          resultsList.appendChild(li);
        });
      } catch (err) {
        errorEl.textContent = 'Network error: ' + err.message;
        statusEl.textContent = '';
      }
    });

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
