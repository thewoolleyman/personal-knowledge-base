{
  "formula": "mol-obtain-oauth-secret",
  "description": "Interactive AI-assisted walkthrough for obtaining OAuth credentials from any cloud provider. Start Claude Code with `claude --chrome`, then pour this formula. Claude guides you step-by-step, opens URLs, answers questions, writes .env, and verifies the setup.",
  "version": 1,
  "type": "workflow",
  "vars": {
    "provider": {
      "description": "Cloud provider name (e.g., google, github, slack)",
      "required": true
    },
    "service": {
      "description": "Service name for display (e.g., Google Drive + Gmail, Slack, Notion)",
      "required": true
    },
    "console_url": {
      "description": "URL to the provider's developer/API console",
      "required": true
    },
    "apis": {
      "description": "Comma-separated list of APIs to enable",
      "required": true
    },
    "env_client_id": {
      "description": "Environment variable name for client ID",
      "required": true
    },
    "env_client_secret": {
      "description": "Environment variable name for client secret",
      "required": true
    },
    "scopes": {
      "description": "OAuth scopes needed (comma-separated)",
      "default": "readonly"
    },
    "app_type": {
      "description": "OAuth application type (desktop, web)",
      "default": "desktop"
    }
  },
  "steps": [
    {
      "id": "prerequisites",
      "title": "Verify prerequisites",
      "description": "Claude checks: (1) claude --chrome is active (browser tool available), (2) .env.example exists, (3) confirm which {{provider}} account the user will use. Ask the user if they already have a {{provider}} developer project or need to create one."
    },
    {
      "id": "open-console",
      "title": "Open {{provider}} developer console",
      "type": "human",
      "description": "Claude runs `open {{console_url}}` to open the browser. Claude uses the browser tool to verify the page loaded. Ask the user: 'Are you signed in? Do you see your project, or do we need to create one?'",
      "needs": ["prerequisites"]
    },
    {
      "id": "enable-apis",
      "title": "Enable {{apis}}",
      "type": "human",
      "description": "Claude opens the API library page. Walk the user through enabling each API in {{apis}}: tell them exactly what to search for, what button to click, and confirm each one is enabled. Ask after each: 'Do you see the Enabled status?'",
      "needs": ["open-console"]
    },
    {
      "id": "consent-screen",
      "title": "Configure OAuth consent screen",
      "type": "human",
      "description": "Claude opens the consent screen page. Walk through each field: user type (External), app name, emails, scopes ({{scopes}}). Remind the user to add themselves as a test user. If the user has questions about any field, explain what it means. Ask: 'Have you saved the consent screen? Did you add yourself as a test user?'",
      "needs": ["enable-apis"]
    },
    {
      "id": "create-credentials",
      "title": "Create OAuth client ID ({{app_type}} app)",
      "type": "human",
      "description": "Claude opens the credentials page. Tell the user: click Create Credentials > OAuth client ID, select {{app_type}} app, give it a name. When the modal shows the Client ID and Client Secret, tell the user: 'Copy the Client ID now and paste it here.' Then: 'Copy the Client Secret and paste it here.' Claude stores both values for the next step.",
      "needs": ["consent-screen"]
    },
    {
      "id": "configure-env",
      "title": "Write credentials to .env",
      "description": "Claude writes the credentials to .env (creating from .env.example if needed). Sets {{env_client_id}} and {{env_client_secret}} with the values the user pasted. The user never edits .env manually. Claude verifies .env is in .gitignore.",
      "needs": ["create-credentials"]
    },
    {
      "id": "verify-auth",
      "title": "Run auth flow and verify",
      "type": "human",
      "description": "Claude runs: source .env && export {{env_client_id}} {{env_client_secret}} && make build && ./pkb auth. This opens the browser for the OAuth consent flow. Tell the user: 'Authorize the app in the browser window that just opened.' After auth completes, Claude runs ./pkb search 'test' to verify. Report success or troubleshoot.",
      "needs": ["configure-env"]
    }
  ]
}
