{
  "formula": "mol-obtain-secret",
  "description": "Interactive AI-assisted walkthrough for obtaining credentials (OAuth or API token) from any provider. Start Claude Code with `claude --chrome`, then pour this formula. Claude guides you step-by-step, opens URLs, answers questions, writes .env, and verifies the setup.",
  "version": 1,
  "type": "workflow",
  "vars": {
    "provider": {
      "description": "Provider name (e.g., google, github, slack, notion)",
      "required": true
    },
    "service": {
      "description": "Service name for display (e.g., Google Drive + Gmail, Slack, GitHub)",
      "required": true
    },
    "secret_type": {
      "description": "Type of credential: 'oauth' (client ID + secret + consent screen) or 'token' (single API key/token)",
      "default": "oauth"
    },
    "console_url": {
      "description": "URL to the provider's developer/API console",
      "required": true
    },
    "apis": {
      "description": "APIs to enable (comma-separated). Leave empty if not applicable.",
      "default": ""
    },
    "env_vars": {
      "description": "Env var names to configure (comma-separated). For OAuth: 'PKB_X_CLIENT_ID,PKB_X_CLIENT_SECRET'. For token: 'PKB_X_TOKEN'.",
      "required": true
    },
    "scopes": {
      "description": "OAuth scopes (comma-separated). Ignored for token type.",
      "default": ""
    },
    "app_type": {
      "description": "OAuth application type (desktop, web). Ignored for token type.",
      "default": "desktop"
    },
    "verify_command": {
      "description": "Command to verify credentials work after setup.",
      "default": "./pkb search 'test'"
    }
  },
  "steps": [
    {
      "id": "prerequisites",
      "title": "Verify prerequisites",
      "description": "Claude checks: (1) claude --chrome is active (browser tool available), (2) .env.example exists, (3) confirm which {{provider}} account the user will use. Ask if they already have a {{provider}} developer project/app or need to create one."
    },
    {
      "id": "open-console",
      "title": "Open {{provider}} developer console",
      "type": "human",
      "description": "Claude runs `open {{console_url}}` to open the browser. Uses browser tool to verify page loaded. Ask: 'Are you signed in? Do you see your project, or do we need to create one?'",
      "needs": ["prerequisites"]
    },
    {
      "id": "enable-apis",
      "title": "Enable required APIs",
      "type": "human",
      "description": "If {{apis}} is non-empty: walk user through enabling each API listed in {{apis}}. Tell them what to search for, what to click, confirm each is enabled. If {{apis}} is empty: skip this step.",
      "needs": ["open-console"]
    },
    {
      "id": "configure-provider",
      "title": "Configure {{provider}} for {{secret_type}}",
      "type": "human",
      "description": "For secret_type=oauth: open consent screen page, walk through user type (External), app name, emails, scopes ({{scopes}}), remind user to add themselves as test user. For secret_type=token: navigate to the token/key generation page in the provider dashboard. Guide user through any provider-specific configuration.",
      "needs": ["enable-apis"]
    },
    {
      "id": "obtain-credentials",
      "title": "Obtain {{secret_type}} credentials",
      "type": "human",
      "description": "For secret_type=oauth: Create Credentials > OAuth client ID, select {{app_type}} app, name it, copy Client ID and Client Secret. For secret_type=token: generate or locate the API token/key. Ask user to paste each credential value into the chat.",
      "needs": ["configure-provider"]
    },
    {
      "id": "configure-env",
      "title": "Write credentials to .env",
      "description": "Write credentials to .env (creating from .env.example if needed). Set each var in {{env_vars}} with the values the user pasted. Verify .env is in .gitignore.",
      "needs": ["obtain-credentials"]
    },
    {
      "id": "verify",
      "title": "Verify setup",
      "type": "human",
      "description": "Source .env, export the vars in {{env_vars}}, run make build. For secret_type=oauth: run ./pkb auth to trigger browser-based OAuth flow, tell user to authorize. For secret_type=token: skip auth step. Then run {{verify_command}} to confirm credentials work. Report success or troubleshoot.",
      "needs": ["configure-env"]
    }
  ]
}
